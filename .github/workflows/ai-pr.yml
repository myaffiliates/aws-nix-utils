name: PR Assistant
on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup droid CLI
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Analyze and generate suggestions
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
        run: |
          # Get the diff and commit messages
          git diff origin/${{ github.base_ref }}...HEAD > pr_changes.diff
          git log origin/${{ github.base_ref }}...HEAD --pretty=format:"%s%n%b%n---" > commit_messages.txt

          # Generate review suggestions (pipe diff and commit messages to stdin)
          cat pr_changes.diff commit_messages.txt | droid exec --auto medium "
          Review this PR diff and commit messages. The commit messages provide context for the changes.

          Generate a review.md file with:
          1. Summary of what the PR is trying to accomplish (based on commit messages)
          2. Code suggestions as GitHub PR review comments in this format for each suggestion:
             \`\`\`suggestion
             file: <filepath>
             line: <line_number>
             suggestion: |
               <suggested_code>
             comment: <explanation>
             \`\`\`
          3. Issues found (bugs, typos, linting errors, missing error handling)
          4. Security or performance concerns
          5. Test coverage recommendations

          DO NOT modify any files. Only write review.md with suggestions.
          Do not make suggestions for Github Actions workflows or CI config files.
          Keep suggestions concise and actionable.
          "

      - name: Post review comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reviewBody = '## ðŸ¤– Automated Review\n\n';

            if (fs.existsSync('review.md')) {
              const reviewContent = fs.readFileSync('review.md', 'utf8');
              reviewBody += reviewContent;

              // Parse suggestions and create review comments
              const suggestionRegex = /```suggestion\nfile: (.+)\nline: (\d+)\nsuggestion: \|\n([\s\S]*?)\ncomment: (.+)\n```/g;
              const comments = [];
              let match;

              while ((match = suggestionRegex.exec(reviewContent)) !== null) {
                const [, path, line, suggestion, comment] = match;
                comments.push({
                  path: path.trim(),
                  line: parseInt(line.trim()),
                  body: `${comment.trim()}\n\n\`\`\`suggestion\n${suggestion.trim()}\n\`\`\``
                });
              }

              // Create PR review with suggestions if any were found
              if (comments.length > 0) {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  event: 'COMMENT',
                  comments: comments
                });
              }
            } else {
              reviewBody += 'Review completed successfully. No issues found.';
            }

            // Post summary comment
            # await github.rest.issues.createComment({
            #   owner: context.repo.owner,
            #   repo: context.repo.repo,
            #   issue_number: context.issue.number,
            #   body: reviewBody
            # });
